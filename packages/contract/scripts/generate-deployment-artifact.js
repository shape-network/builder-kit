const fs = require('node:fs');
const path = require('node:path');

const CONTRACT_NAME = 'HelloShape';
const MODULE_KEY = 'HelloShapeModule#HelloShape';

const NETWORKS = [
  { name: 'shapeSepolia', chainId: 11011 },
  { name: 'shapeMainnet', chainId: 360 },
];

function readJson(filePath) {
  if (!fs.existsSync(filePath)) return null;
  return JSON.parse(fs.readFileSync(filePath, 'utf8'));
}

function getDeploymentAddress(chainId) {
  const deployedAddressesPath = path.join(
    __dirname,
    '..',
    'ignition',
    'deployments',
    `chain-${chainId}`,
    'deployed_addresses.json',
  );

  const deployedAddresses = readJson(deployedAddressesPath);
  return deployedAddresses?.[MODULE_KEY] ?? null;
}

function buildDeploymentMap() {
  return Object.fromEntries(
    NETWORKS.map((network) => [
      String(network.chainId),
      {
        [CONTRACT_NAME]: {
          address: getDeploymentAddress(network.chainId),
        },
      },
    ]),
  );
}

function writeJsonDeployment(deployments) {
  const payload = {
    contracts: deployments,
  };

  const outPath = path.join(__dirname, '..', 'deployments', 'deployed-contracts.json');
  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, `${JSON.stringify(payload, null, 2)}\n`);

  return outPath;
}

function writeWebTypeScript(deployments) {
  const tsOutPath = path.join(
    __dirname,
    '..',
    '..',
    '..',
    'apps',
    'web',
    'lib',
    'contracts',
    'generated',
    'deployed-contracts.ts',
  );

  const fileContents = `// Auto-generated by packages/contract/scripts/generate-deployment-artifact.js\n\nexport const deployedContracts = ${JSON.stringify(deployments, null, 2)} as const;\n\nexport type DeployedContracts = typeof deployedContracts;\nexport type SupportedChainId = keyof DeployedContracts;\n`;

  fs.mkdirSync(path.dirname(tsOutPath), { recursive: true });
  fs.writeFileSync(tsOutPath, fileContents);

  return tsOutPath;
}

function main() {
  const deployments = buildDeploymentMap();

  const jsonPath = writeJsonDeployment(deployments);
  const tsPath = writeWebTypeScript(deployments);

  console.log(`Generated deployment JSON: ${jsonPath}`);
  console.log(`Generated web TypeScript artifact: ${tsPath}`);
}

main();
